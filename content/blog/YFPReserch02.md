---
title: "横浜フィッシングピアーズ海釣り施設、釣果分析 その２"
date: 2021-05-13T12:14:57+09:00
tags: [ fishing, powerbi, python ]
categories: [ fishing]

draft: false
---

![powerbi](/img/powebi.png)

前回、横浜フィッシングピアーズ海釣り施設の釣果分析記事を紹介しました。
分析ツールに Python の統計ライブラリを使用し、仮説を立てて検証する方法をとりました。
分析レポートの整備を進めてきましたが、このやり方だと色々と不都合を感じることがありました。
Python 言語でのコーディングがベースの作業となるため、コーディング中にエラーがでたり、
統計ライブラリの API がわからないときはその都度、調査が必要となり、
分析に集中できないことがありました。
Excelの様に直観的に操作でき、より手軽なツールの方が良いのではないかと検討をすすめ、今回、釣果分析プロジェクト 「fising-piers-fan」 に Microsoft の PowerBI を導入しました。
本ツールの利用手順についてまとめます。

- [システム概要](#システム概要)
  - [PowerBI とは](#powerbi-とは)
- [セットアップ手順](#セットアップ手順)
  - [Python 3 インストール](#python-3-インストール)
  - [釣果収集ライブラリセットアップ](#釣果収集ライブラリセットアップ)
  - [PowerBIセットアップ](#powerbiセットアップ)
- [利用手順](#利用手順)
  - [釣果収集](#釣果収集)
  - [PowerBI レポート分析](#powerbi-レポート分析)
    - [データの更新](#データの更新)
    - [検索条件の指定](#検索条件の指定)
    - [レポートの選択](#レポートの選択)
    - [狙い目のマスターデータメンテナンス](#狙い目のマスターデータメンテナンス)
- [まとめ](#まとめ)

# システム概要

システム全体の構成は以下の通りです。

![img](/img/yfp_system_conf.drawio.png)

* yfp コマンド

  Python のコマンドラインツールで Python ライブラリやデータベースを管理します。
  本コマンドを実行して次の Python ライブラリを制御します。

* piersfan ライブラリ

  Python ライブラリで各海釣り施設のホームページから、釣果情報を収集してデータベースに登録します。

* 釣果データベース

  SQLite3 データベースで、上記処理で定期的に収集した釣果データを蓄積します。

* 分析ツール 1 「仮説を立てた分析」

  Jupyter notebook の Web コンソールを用いて分析レポートを作成します。
  Python 言語を使用して分析レポートをコーディングします。

* 分析ツール 2 「その場かぎりの分析」

  Microsoft の BI ツール PowerBI を用います。
  GUI での操作が中心で、Excel のような操作で分析を行います。

今回、分析ツールは上記2本立てにしました。
一つ目は、前回の記事でまとめた、いつ、どこでどのような条件で釣果が良いのかを仮説を立てて、分析するアプローチになります。Python 統計解析ライブラリを使用して、長期間のデータを検証する手法となります。
二つ目は短期的な釣果分析で、次の釣行計画の準備でとりあえず最近の釣果傾向を調べて釣行を決めるなど、手軽に分析を行うアプローチになります。短期間で分析を完結させることが重要で、GUI操作で手早く結果を得るときに使用します。

## PowerBI とは

今回、導入した PowerBI ですが、「その場かぎりの分析」に適したツールで、以下の特徴があります。

引用：[「Excelから簡単に分析できるPowerBI超入門」](https://swri.jp/article/589)

> PowerBIは、マイクロソフトが力を入れているプログラムで、「対話型のデータ可視化BIツール」だ。簡単に言ってしまうと売上や在庫などのデータから、さまざまな形で情報を取りだしてグラフ等による可視化ができるものだ。「PowerBI Desktop」なら、だれでも無料で利用可能だ。

ほとんどの操作はGUIなので、手軽で、戸惑うことなく分析に集中できます。
ただし、機能は豊富なため、事前に基本的な操作を習得しておかないと利用に戸惑うことがあるかと思います。以下のリファレンスサイトが基本操作の習得にお勧めで、チュートリアル形式で操作を学べます。

* [PowerBI自習書](http://www.sqlquality.com/Self2016/PowerBIver2/Text/Step01-01.html)
* [Online Book: Power BI From Rookie to Rockstar - RADACAD](https://radacad.com/online-book-power-bi-from-rookie-to-rockstar)

２つめは英語となりますが、とても良くまとまっている優良サイトです。ページ数が豊富なので全て読むのは大変ですが、その中で第一部の章を読めば、主要な操作は習得できます。

# セットアップ手順

Windows 10 64ビット版環境でツールのセットアップから利用までの手順を記します。

## Python 3 インストール

事前に、Python 3 の環境が必要です。以下のリファレンスを参考にしてPython をインストールしてください。

[Windows版Pythonのインストール](https://www.python.jp/install/windows/install.html)

## 釣果収集ライブラリセットアップ

以下のGitHub URLから、釣果分析プロジェクトfishing-piers-fanをダウンロードします。

```
https://github.com/mon3nr/fishing-piers-fan
```

ダウンロードファイル fishing-piers-fan-main.zip を任意のディレクトリに解凍します。ここでは、c:\home の下に解凍します。解凍したディレクトリに移動し、Python ライブラリをインストールします。

```
# PowerShell コンソールを開いて実行
cd c:\home\fishing-piers-fan-main
python -m pip install -e .
```

インストールが終わったら、yfp -h で yfp コマンドヘルプが正しく実行できるか確認してください。

```
yfp -h
```

次節の PowerBI セットアップでデータベースの接続設定が必要なので、以下のコマンドでデータベースを初期化してください。

```
yfp --init
```

## PowerBIセットアップ

[PowerBIセットアップ](https://github.com/mon3nr/fishing-piers-fan/blob/main/docs/setup_powerbi.md)に記した手順で PowerBI をインストールします。

インストールしたら PowerBI を起動します。
メニューの「ファイル」、「レポートを開く」を選択して、以下のレポートファイルを開きます。

```
C:\home\fishing-piers-fan-main\notebook\yfpresarch1.pbix
```

メニューの「ファイル」、「オプションと設定」、「データソース設定」を選択して、データソース設定を開きます。

「ソースの変更」をクリックして、ODBCからのインポート画面で以下を設定します。

* データソース名(DNS)に、「SQLite3 Datasource」を選ぶ
* 詳細設定オプションに、「database={インストールディレクトリ}\data\fishing_result.db」を記入する。C:\home\fishing-piers-fan-mainの場合は以下の通り。
  ```
  database=C:\home\fishing-piers-fan-main\data\fishing_result.db
  ```
* サポートされている行の削減句で、「検出」をクリックしてログイン画面を表示。
  * ユーザ名に任意の名前で「test」を入力し、それ以外は空欄のまま「接続」をクリック
  * プライバシーレベルを「パブリック」にして「保存」をクリック
* 「OK」をクリックし、さらに「閉じる」をクリックして設定を反映。

以上でセットアップは終了です。PowerBIメニューから「ファイル」、「保存」を選択して、設定を保存してください。

# 利用手順

## 釣果収集

yfpコマンドを実行して、海づり施設の釣果データを収集します。
各施設のホームページを巡回して、当月の釣果情報を収集して、データベースに登録します。
記事執筆時は2021/5/14 なので、5月中の5/1～5/14までのデータを収集します。

```
# PowerShell コンソールを開いて実行
yfp
```


より長期のデータを収集する場合は、「-m {月}」オプションで何カ月前からダウンロードするかを指定してください。

```
# 過去 3 年(36カ月)の釣果を収集する場合
yfp -m 36 
```

今回は手動で yfp コマンドを実行しましたが、運用する場合は OS スケジューラに日次で yfp コマンドを設定することを推奨します。
定期的に yfp コマンドを実行することで、自動で最新の釣果データを
データベースに蓄積することが可能になります。

## PowerBI レポート分析

釣果データの収集が終わったら、PowerBIで分析を行います。
PowerBI を起動し、レポートファイル yfpresarch1.pbix を開きます。
レポートは、fishing-piers-fan-main\notebookの下に保存してあります。

![PowerBI画面](/img/bireport01.drawio.png)

上記初期画面が開いたら、以下の順で操作します。

### データの更新 

初めに「更新」をクリックして、データベースから分析に必要なデータをすべて取り込みます。
前述の「yfp」コマンドでデータベースを更新した後は、本メニューをクリックして、データの再読み込みをしてください。

### 検索条件の指定

分析対象の絞り込みをします。

![PowerBI画面2](/img/bireport02.drawio.png)

1. 期間の指定

    どの期間の釣果を分析するかを指定します。

2. 施設の指定

    分析対象の施設をチェックします。
    全てのチェックを外すと全施設になります。
    CTRLキーを押しながら、チェックすると複数施設を選択できます。

3. 平日、休日の指定

    対象期間で平日、休日のみに絞り込むときにチェックします。
    アジなどは平日、休日の違いにより釣果が大きく異なるため、狙う魚種により必要に応じて絞り込みをします。

4. 狙い目の指定

    どの魚種をターゲットにするかの魚種カテゴリをチェックします。チェックしたカテゴリの魚種が右側のリストに表示されます。本カテゴリは後述のマスターメンテナンスで編集可能です。

5. 魚種の指定

    狙い目の指定で指定した魚種カテゴリからさらに魚種を絞り込むときにその項目をチェックします。
    本リストもCTLキーを押しながらチェックすると複数選択が可能です。

検索条件を変更すると、その条件に合った分析グラフが表示されます。
本レポートでいつ、どこで、どの魚種の釣果が良かったかを分析し、釣行前の釣行計画などに利用します。

### レポートの選択

「釣果コメント」のシートを選択すると、釣果情報コメントを検索できます。

![釣果コメント分析](/img/bireport03.drawio.png)

Python 言語による分析は釣果数、入場者数などの定量データを中心とした分析となりますが、
PowerBI の場合はこのようなテキスト分析に向いています。日本語表示も問題なくできます。

画面下のレポートリストの一番右にある「＋」をクリックすると新規レポートが作成され、グラフ、表などのカスタマイズが可能です。
前述の PowerBI リファレンスを参考にして、オリジナルのレポートを作成してみて下さい。

### 狙い目のマスターデータメンテナンス

検索条件で指定する狙い目のリストですが、以下の手順で編集が可能です。
インストールディレクトリに移動し、「data/config.tmol」ファイルを開きます。

```
# PowerShellコンソールを開く
cd c:\home\fishing-piers-fan-main
notepad data\config.toml
```

下記で始まるセクションで、name に狙い目の魚種名、species に対象魚種リストを記述します。

```
[[target]]

name = 'アジ'
species = [
    'アジ','シマアジ','イトヒキアジ','ギンガメアジ','マメアジ','コアジ',
]
```

対象魚種リストの指定ですが、PowerBI の狙い目のリスト上の消しゴムアイコンをクリックすると、右側に全ての対象魚種のリストが表示されますので、この中から対象魚種指定してください。

![狙い目](/img/bireport04.drawio.png)

config.tmol を保存したら、以下のコマンドでデータベースにマスター登録します。

```
yfp --loadmaster
```

# まとめ

今回、2本立ての分析方法でシステムをまとめました。
長期的な分析をして知見を得るには Python 言語による仮説を立てた分析が有効となり、
次の釣行計画などその場かぎりの分析には今回の PowerBI が有効となります。
分析基盤としては、これで一通り整備できたのかと思います。
今後、自然言語処理と組み合わせて釣果速報などのコメントをキーワードで分析できる仕組みを整備していく予定です。

ぜひ利用してみてください。今後の釣行計画に役立てれば幸いです。

* Fishing Piers Fan

  横浜海釣り施設釣行計画のための釣果分析プロジェクト。

  https://github.com/mon3nr/fishing-piers-fan

